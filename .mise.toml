[tools]
python = "3.14.2"
uv = "0.9.27"
ollama = "0.15.2"

[env]
_.python.venv = { path = ".venv", create = true }

[tasks.setup]
description = "Initial setup (Anthropic provider)"
run = """
brew install orbstack redis
brew services start redis
mkdir -p logs
uv sync
echo "Setup complete! Next: mise run build && mise run up"
echo "For local LLM: mise run setup-ollama && mise run ollama:pull && LLM_PROVIDER=ollama mise run up"
"""

[tasks.setup-ollama]
description = "Setup Ollama for local LLM"
run = """
mise install ollama
echo "Ollama installed. Next: mise run ollama:pull"
"""

[tasks.sync]
description = "Sync Python dependencies"
run = "uv sync"

[tasks.build]
description = "Build Docker image"
run = "docker compose build"

[tasks.up]
description = "Start brain service"
run = """
docker compose up -d
echo "Brain: http://localhost:8000"
echo "Health: mise run health"
"""

[tasks.down]
description = "Stop brain"
run = "docker compose down"

[tasks.restart]
description = "Restart brain"
run = "docker compose restart brain"

[tasks.logs]
description = "View logs"
run = "docker compose logs -f brain"

[tasks.shell]
description = "Shell into container"
run = "docker compose exec brain /bin/bash"

[tasks.test]
description = "Run tests"
run = "docker compose exec brain pytest tests/ -v"

[tasks.clean]
description = "Remove containers/images"
run = """
docker compose down -v
docker image prune -f
"""

[tasks.health]
description = "Health check"
run = "curl -s http://localhost:8000/health | jq"

[tasks.chat]
description = "Test chat"
run = """
curl -X POST http://localhost:8000/chat \
  -H "user_id: test" \
  -H "session_id: test" \
  -H "Content-Type: application/json" \
  -d '{"message": "Hello", "interface": "api", "language": "en"}' | jq
"""

[tasks.stats]
description = "Resource usage"
run = "docker stats brain-service --no-stream"

[tasks.redis-cli]
description = "Redis CLI"
run = "redis-cli"

[tasks."ollama:setup"]
description = "Setup Ollama"
run = """
mkdir -p logs
mise install ollama
if pgrep -f 'ollama serve' > /dev/null; then
  echo "Ollama already running"
else
  ollama serve > logs/ollama.log 2>&1 &
  sleep 2
  if pgrep -f 'ollama serve' > /dev/null; then
    echo "Ollama started successfully"
  else
    echo "Failed to start Ollama - check logs/ollama.log"
    exit 1
  fi
fi
echo "Next: mise run ollama:pull"
"""

[tasks."ollama:pull"]
description = "Pull recommended models"
run = """
ollama pull llama3.1:8b
ollama pull qwen2.5-coder:7b
echo "Models pulled. Test with: LLM_PROVIDER=ollama mise run up"
"""

[tasks."ollama:serve"]
description = "Start Ollama server"
run = """
if pgrep -f 'ollama serve' > /dev/null; then
  echo "Ollama already running"
else
  ollama serve > logs/ollama.log 2>&1 &
  sleep 2
  if pgrep -f 'ollama serve' > /dev/null; then
    echo "Ollama started successfully"
  else
    echo "Failed to start Ollama - check logs/ollama.log"
    exit 1
  fi
fi
"""

[tasks."ollama:stop"]
description = "Stop Ollama server"
run = "pkill -f 'ollama serve'"

[tasks."ollama:list"]
description = "List installed models"
run = "ollama list"

[tasks.lint]
description = "Run linters"
run = """
uv run ruff check src/ tests/
uv run ruff format --check src/ tests/
uv run mypy src/
uv run pyrefly check src/
"""

[tasks.format]
description = "Format code"
run = """
uv run ruff check --fix src/ tests/ interfaces/
uv run ruff format src/ tests/ interfaces/
"""

# Telegram bot tasks
[tasks."telegram:install"]
description = "Install telegram bot dependencies"
run = "uv sync --extra telegram"

[tasks."telegram:start"]
description = "Start telegram bot"
run = """
cd interfaces/telegram
uv run --extra telegram python -m .
"""

[tasks."telegram:install-service"]
description = "Install telegram bot as LaunchAgent (macOS)"
run = """
mkdir -p ~/Library/LaunchAgents
cat > ~/Library/LaunchAgents/com.agentic-brain.telegram-bot.plist << EOF
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
    <key>Label</key>
    <string>com.agentic-brain.telegram-bot</string>
    <key>ProgramArguments</key>
    <array>
        <string>/bin/bash</string>
        <string>-c</string>
        <string>cd $PWD/interfaces/telegram && source $PWD/.venv/bin/activate && python -m .</string>
    </array>
    <key>RunAtLoad</key>
    <true/>
    <key>KeepAlive</key>
    <true/>
    <key>StandardOutPath</key>
    <string>$PWD/logs/telegram-bot.log</string>
    <key>StandardErrorPath</key>
    <string>$PWD/logs/telegram-bot.error.log</string>
    <key>WorkingDirectory</key>
    <string>$PWD/interfaces/telegram</string>
</dict>
</plist>
EOF
echo "LaunchAgent installed. Use 'mise run telegram:service:start' to start."
"""

[tasks."telegram:service:start"]
description = "Start telegram bot service"
run = "launchctl load ~/Library/LaunchAgents/com.agentic-brain.telegram-bot.plist"

[tasks."telegram:service:stop"]
description = "Stop telegram bot service"
run = "launchctl unload ~/Library/LaunchAgents/com.agentic-brain.telegram-bot.plist"

[tasks."telegram:service:status"]
description = "Check telegram bot service status"
run = "launchctl list | grep telegram-bot || echo 'Service not running'"

[tasks."telegram:logs"]
description = "View telegram bot logs"
run = "tail -f logs/telegram-bot.log"
